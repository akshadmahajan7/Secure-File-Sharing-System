{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<h2 class="mb-4 text-dark"><i class="fas fa-folder-open me-3 text-warning"></i>My Secure Files & Shares</h2>

<div class="row g-4">
    <!-- File Upload Card -->
    <div class="col-md-4">
        <div class="card shadow-lg border-info h-100">
            <div class="card-header bg-info text-white p-3">
                <h5 class="mb-0"><i class="fas fa-cloud-upload-alt me-2"></i>Upload New File</h5>
            </div>
            <div class="card-body p-4">
                <form method="POST" action="{{ url_for('main.upload_file') }}" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label for="file" class="form-label fw-bold">Select File for Encryption</label>
                        <input class="form-control" type="file" id="file" name="file" required>
                    </div>
                    <button type="submit" class="btn btn-info btn-lg w-100 shadow-md">
                        <i class="fas fa-lock me-2"></i> Encrypt & Upload
                    </button>
                </form>
                <small class="text-muted mt-3 d-block text-center">Files are encrypted locally before being saved to storage.</small>
            </div>
        </div>
    </div>
    
    <!-- File List Table -->
    <div class="col-md-8">
        <div class="card shadow-lg h-100">
            <div class="card-header bg-light border-bottom p-3">
                <h5 class="mb-0">File List (Access Granted)</h5>
            </div>
            <div class="card-body p-0">
                {% if files %}
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th class="col-6">Filename</th>
                                <th class="col-2">Access Type</th>
                                <th class="col-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in files %}
                            <tr>
                                <td><i class="fas fa-file-code me-2 text-primary"></i><strong>{{ file.filename }}</strong></td>
                                <td>
                                    <span class="badge rounded-pill fw-bold 
                                        {% if file.owner_id == current_user.id %}
                                            bg-success
                                        {% else %}
                                            bg-secondary
                                        {% endif %}">
                                        {% if file.owner_id == current_user.id %}Owned{% else %}Shared by {{ file.owner.username }}{% endif %}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <a href="{{ url_for('main.download_file', file_id=file.id) }}" class="btn btn-sm btn-success me-2" title="Download & Decrypt">
                                        <i class="fas fa-file-download"></i> Download
                                    </a>
                                    {% if file.owner_id == current_user.id %}
                                        <a href="{{ url_for('main.share_file', file_id=file.id) }}" class="btn btn-sm btn-warning me-2" title="Share with another user">
                                            <i class="fas fa-share-alt"></i> Share
                                        </a>
                                        <!-- Delete Button -->
                                        <form method="POST" action="{{ url_for('main.delete_file', file_id=file.id) }}" class="d-inline" onsubmit="return confirm('WARNING: Are you sure you want to permanently delete {{ file.filename }}? This cannot be undone.');">
                                            <button type="submit" class="btn btn-sm btn-danger" title="Delete File & Revoke All Access">
                                                <i class="fas fa-trash-alt"></i> Delete
                                            </button>
                                        </form>
                                        <!-- End Delete Button -->
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="p-5 text-center text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p class="mb-0">No files found. Upload a file or wait for one to be shared with you!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}